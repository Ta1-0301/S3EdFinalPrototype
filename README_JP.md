# S3Ed Final Prototype - AR Bus Navigation App (React + Ionic/Capacitor)

Dunedinのバス路線（ルート番号1）を対象としたARナビゲーションアプリのプロトタイプです。
React, Vite, Three.js (@react-three/fiber), Capacitor を使用して開発されています。

[English Version is here](README.md)

## 主な機能

*   **ARナビゲーション**: 実写カメラ映像の上に3Dの矢印を表示し、次の進行方向を直感的に案内します。
*   **ルート案内**: 事前に定義されたルート（JSON）に基づき、GPS位置情報を使ってナビゲーションを行います。
*   **ミニマップ**: 画面下部にGoogleマップ風のミニマップを表示し、ルート全体と現在地、バス停の位置を可視化します。
*   **音声案内**: バス停に近づくと自動的に音声（またはTTS）でアナウンスを再生します（現在ダミー音声ファイル使用）。
*   **UI/UX**: ダークモードを基調としたモダンなデザイン。縦画面・横画面の両方に対応。

## 技術スタック

*   **Frontend**: React (TypeScript), Vite
*   **3D/AR**: Three.js, @react-three/fiber
*   **Mobile**: Ionic Capacitor (Android)
*   **Styling**: Vanilla CSS (CSS Modules approach)
*   **Location**: Geolocation API, DeviceOrientation API

## インストールと実行

### 必要要件
*   Node.js (v18+)
*   Android Studio (Androidビルド用)

### 手順

1.  依存関係のインストール:
    ```bash
    npm install
    ```

2.  開発サーバーの起動 (ブラウザで確認):
    ```bash
    npm run dev
    ```

3.  Androidアプリのビルド:
    ```bash
    npm run build
    npx cap sync android
    npx cap open android
    ```

---

## 変更履歴 (Changelog)

これまでの開発における主な変更・追加機能の履歴です。

### 全体
*   React + Vite + TypeScript によるプロジェクトの初期化。
*   Capacitor の導入により、WebアプリをネイティブAndroidアプリとして動作可能に設定。
*   Windows環境での開発に対応（日本語パス問題の回避設定など）。

### 1. ARナビゲーション (ARView)
*   **初期実装**: Three.jsを用いた基本的なカメラと3D空間のセットアップ。
*   **矢印モデル**: 単純なシリンダーから、より視認性の高い「シェブロン（くの字型）」デザインに変更。
*   **アニメーション**: 矢印に浮遊感（Bobbing）を与えるアニメーションを追加。
*   **方向制御**:
    *   GPS座標とコンパス方位を使用して、目的地の方向を計算。
    *   「曲がり角」でのみ目的地を指し、それ以外（直進時）は進行方向（デバイス前方）を指すようにロジックを改良。
    *   360度の境界（北）をまたぐ際の角度計算バグを修正（最短回転制御）。

### 2. ミニマップ (MiniMap)
*   **初期実装**: ルートラインと現在地を表示する簡易マップ。
*   **デザイン刷新**:
    *   Googleマップ風のスタイルに変更。
    *   ルート軌跡をすべて描画し、バス停をアイコンで強調表示。
    *   ユーザーマーカーにパルス（波紋）アニメーションを追加し、視認性を向上。
    *   現在地から次のターゲットまでの点線ガイド表示を追加。

### 3. UI/UX (App, NavigationCard)
*   **レスポンシブ対応**: 縦画面（ポートレート）と横画面（ランドスケープ）でレイアウトが自動的に切り替わるように実装。
*   **デザインシステム**: 黒背景に黄緑（Lime Green）をアクセントカラーとしたダークテーマを採用。
*   **案内カード**: 次の曲がり角やバス停までの距離を表示するカードコンポーネントを作成。
*   **ランドマーク表示**: 画面上に主要な建物名（例: Robertson Library）を表示するラベル機能を追加（現在は一時的に無効化）。

### 4. 機能・ロジック
*   **ルートデータ**: `route.json` によるルート定義（緯度経度、アクションタイプ、バス停情報）。
*   **GPS補正**: `geoUtils.ts` にてヒュベニの公式等を用いた距離・方位計算を実装。
*   **音声再生**: バス停の50m手前でアナウンスを自動再生するロジックを実装。重複再生防止やエラーハンドリングを強化。

### 今後の課題
*   音声ファイルの正式な差し替え。
*   AR矢印の高さ（Pitch）制御（坂道対応）。
*   ランドマーク表示の動的制御の有効化。
